<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="è¨ªå•çœ‹è­·è¨˜éŒ²">
  <title>è¨ªå•çœ‹è­·è¨˜éŒ²</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #f0f7f4 0%, #e8f4f0 50%, #f5f9f7 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    
    html {
      height: -webkit-fill-available;
    }
    
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 40px;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
    }
    
    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(2.5); opacity: 0; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes checkmark {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-top: 10px;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1a2e28;
      margin: 0 0 6px 0;
    }
    
    .header p {
      font-size: 13px;
      color: #6b7c74;
      margin: 0;
    }
    
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 24px rgba(0, 80, 60, 0.08);
      padding: 24px;
      margin-bottom: 16px;
      animation: fadeIn 0.4s ease-out;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #e8f4f0;
      color: #00816a;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
    }
    
    .input-group {
      margin-bottom: 14px;
    }
    
    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    @media (max-width: 500px) {
      .input-row {
        grid-template-columns: 1fr;
      }
    }
    
    .input-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #3d4f46;
      margin-bottom: 6px;
    }
    
    .input-field {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e5ebe8;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s;
      font-family: inherit;
      -webkit-appearance: none;
      background: white;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #00a67d;
    }
    
    .input-field.error {
      border-color: #ef4444;
    }
    
    .input-hint {
      font-size: 11px;
      color: #8a9a92;
      margin-top: 4px;
    }
    
    .input-error {
      font-size: 11px;
      color: #ef4444;
      margin-top: 4px;
    }
    
    .record-section {
      text-align: center;
      padding: 20px 0;
    }
    
    .record-btn {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 12px;
      background: linear-gradient(145deg, #00a67d, #008f6b);
      box-shadow: 0 8px 32px rgba(0, 166, 125, 0.35);
    }
    
    .record-btn:active {
      transform: scale(0.96);
    }
    
    .record-btn.recording {
      background: linear-gradient(145deg, #ef4444, #dc2626);
      box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .ripple-effect {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid rgba(239, 68, 68, 0.6);
      animation: ripple 1.5s ease-out infinite;
    }
    
    .mic-icon {
      width: 44px;
      height: 44px;
      fill: white;
    }
    
    .btn-text {
      color: white;
      font-size: 13px;
      font-weight: 600;
    }
    
    .timer {
      font-size: 12px;
      color: rgba(255,255,255,0.9);
      font-weight: 500;
    }
    
    .record-hint {
      font-size: 12px;
      color: #8a9a92;
      margin: 0;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #3d4f46;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      border: 2px solid #e5ebe8;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    
    .textarea:focus {
      outline: none;
      border-color: #00a67d;
    }
    
    .editable-record {
      width: 100%;
      min-height: 180px;
      padding: 16px;
      border: 2px solid #d4e5dd;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.7;
      font-family: inherit;
      background: linear-gradient(145deg, #f8faf9, #f0f5f3);
      resize: vertical;
    }
    
    .editable-record:focus {
      outline: none;
      border-color: #00a67d;
      background: white;
    }
    
    .result-box {
      background: linear-gradient(145deg, #f8faf9, #f0f5f3);
      border: 2px solid #d4e5dd;
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      color: #2d3b35;
      margin-bottom: 16px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    
    .primary-btn {
      background: linear-gradient(145deg, #00a67d, #008f6b);
      color: white;
      box-shadow: 0 4px 16px rgba(0, 166, 125, 0.25);
    }
    
    .primary-btn:active {
      transform: scale(0.98);
    }
    
    .primary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .secondary-btn {
      background: #f3f7f5;
      color: #4a5a52;
      border: 2px solid #e5ebe8;
    }
    
    .secondary-btn:active {
      background: #e8f0ec;
    }
    
    .error-box {
      background: #fef2f2;
      border: 2px solid #fecaca;
      color: #b91c1c;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      margin-bottom: 14px;
    }
    
    .review-header {
      background: linear-gradient(145deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .review-header-icon {
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .review-header-title {
      font-weight: 600;
      color: #92400e;
      font-size: 14px;
    }
    
    .review-header-desc {
      font-size: 12px;
      color: #a16207;
      margin-top: 2px;
    }
    
    .success-header {
      background: linear-gradient(145deg, #d1fae5, #a7f3d0);
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .success-header-icon {
      flex-shrink: 0;
      animation: checkmark 0.5s ease-out;
    }
    
    .success-header-title {
      font-weight: 600;
      color: #065f46;
      font-size: 15px;
    }
    
    .success-header-desc {
      font-size: 12px;
      color: #047857;
      margin-top: 2px;
    }
    
    .info-row {
      display: flex;
      gap: 16px;
      padding: 10px 14px;
      background: #f8faf9;
      border-radius: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #4a5a52;
    }
    
    .info-label {
      font-weight: 600;
      color: #3d4f46;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5ebe8;
      border-top-color: #00a67d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    .loading-text {
      font-size: 15px;
      color: #3d4f46;
      font-weight: 500;
    }
    
    .guide-box {
      background: rgba(255,255,255,0.6);
      border-radius: 14px;
      padding: 16px;
      margin-top: 8px;
    }
    
    .guide-title {
      font-size: 13px;
      font-weight: 600;
      color: #3d4f46;
      margin-bottom: 10px;
    }
    
    .guide-list {
      margin: 0;
      padding-left: 18px;
      font-size: 12px;
      color: #5a6b62;
      line-height: 1.7;
    }
    
    .hidden {
      display: none !important;
    }
    
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a2e28;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 1001;
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ“‹ è¨ªå•çœ‹è­·è¨˜éŒ²</h1>
      <p>éŸ³å£°å…¥åŠ›ã§ã‹ã‚“ãŸã‚“è¨˜éŒ²ä½œæˆ</p>
    </div>

    <!-- Step: Input -->
    <div id="step-input">
      <!-- Patient Info -->
      <div class="card">
        <div class="badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          åŸºæœ¬æƒ…å ±
        </div>
        
        <div class="input-row">
          <div class="input-group">
            <label class="input-label">è¨ªå•æ—¥</label>
            <input type="date" id="visitDate" class="input-field">
          </div>
          
          <div class="input-group">
            <label class="input-label">åˆ©ç”¨è€…åï¼ˆã‚«ãƒŠï¼‰</label>
            <input type="text" id="patientName" class="input-field" placeholder="ãƒ¤ãƒãƒ€ã‚¿ãƒ­ã‚¦">
            <div id="patientNameHint" class="input-hint">ã‚«ã‚¿ã‚«ãƒŠãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãªã—ã§å…¥åŠ›</div>
            <div id="patientNameError" class="input-error hidden"></div>
          </div>
        </div>
        
        <div class="input-row" style="margin-top: 14px;">
          <div class="input-group">
            <label class="input-label">è·ç¨®</label>
            <select id="jobType" class="input-field">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="çœ‹è­·å¸«">çœ‹è­·å¸«</option>
              <option value="ãƒªãƒãƒ“ãƒªè·">ãƒªãƒãƒ“ãƒªè·</option>
            </select>
          </div>
          
          <div class="input-group">
            <label class="input-label">è¨˜éŒ²è€…</label>
            <input type="text" id="recorderName" class="input-field" placeholder="è¨˜éŒ²è€…å">
          </div>
        </div>
      </div>

      <!-- Recording -->
      <div class="card">
        <div class="record-section">
          <button id="recordBtn" class="record-btn" onclick="toggleRecording()">
            <div id="ripple1" class="ripple-effect hidden"></div>
            <div id="ripple2" class="ripple-effect hidden" style="animation-delay: 0.5s;"></div>
            <svg id="micIcon" class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" fill="none" stroke="white" stroke-width="2"/>
              <line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/>
              <line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/>
            </svg>
            <svg id="stopIcon" class="mic-icon hidden" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="2"/>
            </svg>
            <span id="btnText" class="btn-text">éŒ²éŸ³é–‹å§‹</span>
            <span id="timerText" class="timer hidden">00:00</span>
          </button>
          <p id="recordHint" class="record-hint">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è¨ªå•è¨˜éŒ²ã‚’è©±ã—ã¦ãã ã•ã„</p>
        </div>
      </div>

      <!-- Transcript -->
      <div class="card">
        <div class="section-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00a67d" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ
        </div>
        
        <div id="errorBox" class="error-box hidden"></div>
        
        <textarea id="transcript" class="textarea" placeholder="éŸ³å£°å…¥åŠ›ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç›´æ¥å…¥åŠ›ãƒ»ç·¨é›†ã‚‚å¯èƒ½ã§ã™ã€‚"></textarea>
        
        <div class="button-group">
          <button id="generateBtn" class="action-btn primary-btn" onclick="generateRecord()" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
            è¨˜éŒ²ã‚’ç”Ÿæˆ
          </button>
          
          <button class="action-btn secondary-btn" onclick="resetAll()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>

      <div class="guide-box">
        <div class="guide-title">ğŸ’¡ è¨˜éŒ²ã®ãƒã‚¤ãƒ³ãƒˆ</div>
        <ul class="guide-list">
          <li>ãƒã‚¤ã‚¿ãƒ«ã€èº«ä½“çŠ¶æ…‹ã€å‡¦ç½®å†…å®¹ã‚’ä¼ãˆã¦ãã ã•ã„</li>
          <li>å‰å›ã‹ã‚‰ã®å¤‰åŒ–ã‚„ç‰¹è¨˜äº‹é …ã‚’ä¸­å¿ƒã«</li>
          <li>ç”Ÿæˆå¾Œã«ä¿®æ­£ãƒ»ç·¨é›†ã§ãã¾ã™</li>
        </ul>
      </div>
    </div>

    <!-- Step: Review -->
    <div id="step-review" class="hidden">
      <div class="card">
        <div class="review-header">
          <svg class="review-header-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <div>
            <div class="review-header-title">è¨˜éŒ²å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
            <div class="review-header-desc">ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ç›´æ¥ç·¨é›†ã§ãã¾ã™</div>
          </div>
        </div>

        <div class="info-row">
          <div class="info-item">
            <span class="info-label">è¨ªå•æ—¥:</span>
            <span id="reviewDate"></span>
          </div>
          <div class="info-item">
            <span class="info-label">åˆ©ç”¨è€…:</span>
            <span id="reviewPatient"></span>
          </div>
          <div class="info-item">
            <span class="info-label">è·ç¨®:</span>
            <span id="reviewJobType"></span>
          </div>
          <div class="info-item">
            <span class="info-label">è¨˜éŒ²è€…:</span>
            <span id="reviewRecorder"></span>
          </div>
        </div>

        <div id="reviewError" class="error-box hidden"></div>

        <div class="section-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00a67d" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          ç”Ÿæˆã•ã‚ŒãŸè¨˜éŒ²
        </div>
        
        <textarea id="editableRecord" class="editable-record"></textarea>

        <div class="button-group">
          <button id="saveBtn" class="action-btn primary-btn" onclick="saveRecord()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            ä¿å­˜ã™ã‚‹
          </button>
          
          <button class="action-btn secondary-btn" onclick="copyToClipboard()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            ã‚³ãƒ”ãƒ¼
          </button>
          
          <button class="action-btn secondary-btn" onclick="goBack()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            æˆ»ã‚‹
          </button>
        </div>
      </div>
    </div>

    <!-- Step: Saved -->
    <div id="step-saved" class="hidden">
      <div class="card">
        <div class="success-header">
          <svg class="success-header-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <div>
            <div class="success-header-title">è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼</div>
            <div class="success-header-desc">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ</div>
          </div>
        </div>

        <div class="info-row">
          <div class="info-item">
            <span class="info-label">è¨ªå•æ—¥:</span>
            <span id="savedDate"></span>
          </div>
          <div class="info-item">
            <span class="info-label">åˆ©ç”¨è€…:</span>
            <span id="savedPatient"></span>
          </div>
          <div class="info-item">
            <span class="info-label">è·ç¨®:</span>
            <span id="savedJobType"></span>
          </div>
          <div class="info-item">
            <span class="info-label">è¨˜éŒ²è€…:</span>
            <span id="savedRecorder"></span>
          </div>
        </div>

        <div id="savedRecord" class="result-box"></div>

        <div class="button-group">
          <button class="action-btn primary-btn" onclick="resetAll()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            æ–°ã—ã„è¨˜éŒ²ã‚’ä½œæˆ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">è¨˜éŒ²ã‚’ç”Ÿæˆä¸­...</div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script>
    // ============================================
    // è¨­å®š - GASãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«URLã‚’è¨­å®šã—ã¦ãã ã•ã„
    // ============================================
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzIYN-vW_MPXJDxX9-Gc68AiNb5ks4n8Nx46Um8lzd04v5Oexh3itkZ4mwED8qjrlVovA/exec';
    
    // State
    let isRecording = false;
    let recognition = null;
    let recordingTimer = null;
    let recordingSeconds = 0;
    let currentTranscript = '';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('visitDate').value = today;
      
      document.getElementById('patientName').addEventListener('input', validatePatientName);
      document.getElementById('transcript').addEventListener('input', updateGenerateButton);
      document.getElementById('jobType').addEventListener('change', updateGenerateButton);
      document.getElementById('recorderName').addEventListener('input', updateGenerateButton);
    });

    function validatePatientName() {
      const input = document.getElementById('patientName');
      const hint = document.getElementById('patientNameHint');
      const error = document.getElementById('patientNameError');
      let value = input.value;
      
      // ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆå…¨è§’ãƒ»åŠè§’ï¼‰ã‚’è‡ªå‹•å‰Šé™¤
      const cleanedValue = value.replace(/[\sã€€]/g, '');
      if (value !== cleanedValue) {
        input.value = cleanedValue;
        value = cleanedValue;
      }
      
      // ã‚«ã‚¿ã‚«ãƒŠã®ã¿ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãªã—ï¼‰
      const katakanaRegex = /^[ã‚¡-ãƒ¶ãƒ¼]*$/;
      
      if (value && !katakanaRegex.test(value)) {
        input.classList.add('error');
        hint.classList.add('hidden');
        error.textContent = 'ã‚«ã‚¿ã‚«ãƒŠã®ã¿ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãªã—ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
        error.classList.remove('hidden');
        updateGenerateButton();
        return false;
      } else {
        input.classList.remove('error');
        hint.classList.remove('hidden');
        error.classList.add('hidden');
        updateGenerateButton();
        return true;
      }
    }

    function updateGenerateButton() {
      const transcript = document.getElementById('transcript').value.trim();
      const patientName = document.getElementById('patientName').value.trim();
      const jobType = document.getElementById('jobType').value;
      const recorderName = document.getElementById('recorderName').value.trim();
      const katakanaRegex = /^[ã‚¡-ãƒ¶ãƒ¼]*$/;
      const btn = document.getElementById('generateBtn');
      
      btn.disabled = !transcript || !patientName || !jobType || !recorderName || (patientName && !katakanaRegex.test(patientName));
    }

    function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }

    function startRecording() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showError('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Edgeã€Safariã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      
      // Androidåˆ¤å®š
      const isAndroid = /Android/i.test(navigator.userAgent);
      
      // Androidã¯é€”ä¸­çµŒéã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡ã‚’é˜²ã
      recognition.continuous = true;
      recognition.interimResults = !isAndroid;

      // éŒ²éŸ³é–‹å§‹æ™‚ç‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
      const baseTranscript = document.getElementById('transcript').value;
      let confirmedTranscript = '';
      let lastResultIndex = 0;

      recognition.onresult = function(event) {
        let interimTranscript = '';
        
        // æ–°ã—ã„çµæœã®ã¿ã‚’å‡¦ç†ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        for (let i = lastResultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          if (result.isFinal) {
            confirmedTranscript += result[0].transcript;
            lastResultIndex = i + 1;
          } else if (!isAndroid) {
            // iOS/PCã®ã¿é€”ä¸­çµŒéã‚’è¡¨ç¤º
            interimTranscript = result[0].transcript;
          }
        }
        
        // ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆ + é€”ä¸­çµŒéã‚’è¡¨ç¤º
        document.getElementById('transcript').value = baseTranscript + confirmedTranscript + interimTranscript;
        currentTranscript = baseTranscript + confirmedTranscript;
        updateGenerateButton();
      };

      recognition.onerror = function(event) {
        if (event.error === 'not-allowed') {
          showError('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
        }
        stopRecording();
      };

      recognition.onend = function() {
        if (isRecording) {
          recognition.start();
        }
      };

      recognition.start();
      isRecording = true;
      recordingSeconds = 0;

      const btn = document.getElementById('recordBtn');
      btn.classList.add('recording');
      document.getElementById('micIcon').classList.add('hidden');
      document.getElementById('stopIcon').classList.remove('hidden');
      document.getElementById('btnText').textContent = 'åœæ­¢';
      document.getElementById('timerText').classList.remove('hidden');
      document.getElementById('ripple1').classList.remove('hidden');
      document.getElementById('ripple2').classList.remove('hidden');
      document.getElementById('recordHint').textContent = 'è©±ã—ã¦ãã ã•ã„...';

      recordingTimer = setInterval(function() {
        recordingSeconds++;
        const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
        const secs = (recordingSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timerText').textContent = mins + ':' + secs;
      }, 1000);
    }

    function stopRecording() {
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      
      isRecording = false;
      
      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }

      const btn = document.getElementById('recordBtn');
      btn.classList.remove('recording');
      document.getElementById('micIcon').classList.remove('hidden');
      document.getElementById('stopIcon').classList.add('hidden');
      document.getElementById('btnText').textContent = 'éŒ²éŸ³é–‹å§‹';
      document.getElementById('timerText').classList.add('hidden');
      document.getElementById('ripple1').classList.add('hidden');
      document.getElementById('ripple2').classList.add('hidden');
      document.getElementById('recordHint').textContent = 'ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è¨ªå•è¨˜éŒ²ã‚’è©±ã—ã¦ãã ã•ã„';
    }

    async function generateRecord() {
      const transcript = document.getElementById('transcript').value.trim();
      const patientName = document.getElementById('patientName').value.trim();

      if (!transcript || !patientName || !validatePatientName()) {
        return;
      }

      if (GAS_URL === 'YOUR_GAS_WEB_APP_URL_HERE') {
        showError('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      showLoading('è¨˜éŒ²ã‚’ç”Ÿæˆä¸­...');
      hideError();

      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'generate',
            transcript: transcript
          })
        });

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          throw new Error('Invalid response');
        }
        hideLoading();

        if (result.success && result.data && result.data.record) {
          showReviewStep(result.data.record);
        } else {
          showError(result.message || 'è¨˜éŒ²ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (err) {
        hideLoading();
        showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }

    function showReviewStep(record) {
      const visitDate = document.getElementById('visitDate').value;
      const patientName = document.getElementById('patientName').value;
      const jobType = document.getElementById('jobType').value;
      const recorderName = document.getElementById('recorderName').value;

      document.getElementById('reviewDate').textContent = formatDisplayDate(visitDate);
      document.getElementById('reviewPatient').textContent = patientName;
      document.getElementById('reviewJobType').textContent = jobType;
      document.getElementById('reviewRecorder').textContent = recorderName;
      document.getElementById('editableRecord').value = record;

      document.getElementById('step-input').classList.add('hidden');
      document.getElementById('step-review').classList.remove('hidden');
      document.getElementById('step-saved').classList.add('hidden');
    }

    async function saveRecord() {
      const visitDate = document.getElementById('visitDate').value;
      const patientName = document.getElementById('patientName').value;
      const jobType = document.getElementById('jobType').value;
      const recorderName = document.getElementById('recorderName').value;
      const record = document.getElementById('editableRecord').value;

      showLoading('ä¿å­˜ä¸­...');

      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'save',
            date: visitDate,
            patientName: patientName,
            jobType: jobType,
            recorderName: recorderName,
            record: record
          })
        });

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          throw new Error('Invalid response');
        }
        hideLoading();

        if (result.success) {
          showSavedStep();
        } else {
          showReviewError(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (err) {
        hideLoading();
        showReviewError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    function showSavedStep() {
      const visitDate = document.getElementById('visitDate').value;
      const patientName = document.getElementById('patientName').value;
      const jobType = document.getElementById('jobType').value;
      const recorderName = document.getElementById('recorderName').value;
      const record = document.getElementById('editableRecord').value;

      document.getElementById('savedDate').textContent = formatDisplayDate(visitDate);
      document.getElementById('savedPatient').textContent = patientName;
      document.getElementById('savedJobType').textContent = jobType;
      document.getElementById('savedRecorder').textContent = recorderName;
      document.getElementById('savedRecord').textContent = record;

      document.getElementById('step-input').classList.add('hidden');
      document.getElementById('step-review').classList.add('hidden');
      document.getElementById('step-saved').classList.remove('hidden');
    }

    function formatDisplayDate(dateStr) {
      const date = new Date(dateStr);
      return date.getFullYear() + 'å¹´' + (date.getMonth() + 1) + 'æœˆ' + date.getDate() + 'æ—¥';
    }

    function copyToClipboard() {
      const record = document.getElementById('editableRecord').value;
      
      navigator.clipboard.writeText(record).then(function() {
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      });
    }

    function goBack() {
      document.getElementById('step-input').classList.remove('hidden');
      document.getElementById('step-review').classList.add('hidden');
      document.getElementById('step-saved').classList.add('hidden');
    }

    function resetAll() {
      document.getElementById('patientName').value = '';
      document.getElementById('transcript').value = '';
      document.getElementById('editableRecord').value = '';
      document.getElementById('jobType').value = '';
      document.getElementById('recorderName').value = '';
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('visitDate').value = today;
      
      document.getElementById('step-input').classList.remove('hidden');
      document.getElementById('step-review').classList.add('hidden');
      document.getElementById('step-saved').classList.add('hidden');
      
      hideError();
      updateGenerateButton();
    }

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showError(message) {
      const errorBox = document.getElementById('errorBox');
      errorBox.textContent = message;
      errorBox.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorBox').classList.add('hidden');
    }

    function showReviewError(message) {
      const errorBox = document.getElementById('reviewError');
      errorBox.textContent = message;
      errorBox.classList.remove('hidden');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2000);
    }
  </script>
</body>
</html>
